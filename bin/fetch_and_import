#!/usr/bin/env ruby
# frozen_string_literal: true

puts 'Loading environment...'
require File.expand_path('../../config/environment', __FILE__)
require 'github_importer'

# This retrieves all the files in the directory corresponding to:
# https://github.com/waynegraham/dlme-metadata/tree/master/maps/records/stanford
# 1. Get a personal access token from GitHub (https://github.com/settings/tokens)
#    with the following scopes enabled:
#    * public_repo
# 2. Set an ENV variable named 'GITHUB_TOKEN' containing your token

AUTHORIZATION_TOKEN = ENV['GITHUB_TOKEN'] ||
                      raise('GitHub authorization token was not found in the GITHUB_TOKEN environment variable')
USER = 'waynegraham'
REPO = 'dlme-metadata'
SLUG = 'dlme'

def process_mods(identifier, mods)
  indexer = Traject::Indexer.new('identifier' => identifier, 'exhibit_slug' => SLUG)
  indexer.load_config_file('lib/traject/mods_config.rb')
  indexer.process(mods)
end

importer = GithubImporter.new(AUTHORIZATION_TOKEN, USER, REPO)
importer.import('maps/records/stanford') do |filename, mods|
  identifier = "stanford_#{filename.sub('.mods', '')}"
  process_mods(identifier, mods)
end
